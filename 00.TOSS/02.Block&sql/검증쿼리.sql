SELECT
DT.JOB_DT
, A.TBL_ENNM
, A.TBL_KNM
, B.VALDTN_CCNT AS CBS_CNT
, C.VALDTN_CCNT AS SOR_CNT
, (B.VALDTN_CCNT - C.VALDTN_CCNT) AS CNT_DIFF
, TO_CHAR(TO_TIMESTAMP(B.DW_LDNG_DTTM, \u0027YYYYMMDDHH24MISSFF2\u0027),\u0027HH24:MI:SS) AS CBS_TM
, TO_CHAR(TO_TIMESTAMP(C.DW_LDNG_DTTM, \u0027YYYYMMDDHH24MISSFF2\u0027),\u0027HH24:MI:SS) AS SOR_TM
, D.DATA_PROCS_CCNT AS UD_LOG_CNT
, TO_CHAR(TO_TIMESTAMP(D.DW_LDNG_DTTM, \u0027YYYYMMDDHH24MISSFF2\u0027),\u0027HH24:MI:SS) AS UD_LOG_TM
, E.DATA_PROCS_CCNT
, TO_CHAR(TO_TIMESTAMP(E.DW_LDNG_DTTM, \u0027YYYYMMDDHH24MISSFF2\u0027),\u0027HH24:MI:SS) AS LD_LOG_TM
, Q.UN_DB AS UN_DB
, (CASE WHEN P.TBL_KNM IS NOT NULL THEN \u0027Y\u0027 ELSE \u0027\u0027 END) AS SNAP_EXIST_YN
FROM (
SELECT
SUBSTR(COMMENTS,1,3) AS SUB
,TABLE_NAME AS TBL_ENNM
,COMMENTS AS TBL_KNM
FROM ALL_TAB_COMMENTS
WHERE OWNER \u003d \u0027SOROWN\u0027
AND LENGTH(TABLE_NAME) \u003d 13
AND TABLE_NAME NOT IN (\u0027DOPCO_SORVL_L\u0027)
AND TABLE_NAME NOT LIKE \u0027DRUMS%\u0027
AND TABLE_NAME NOT LIKE \u0027DI%\u0027
) A
INNER
JOIN (
SELECT
TO_CHAR(SYSDATE-1,\u0027YYYYMMDD\u0027) AS JOB_DT
,TO_CHAR(LAST_DAY(SYSDATE-1),\u0027YYYYMMDD\u0027) AS LAST_DT
FROM DUAL
) DT
ON 1\u003d1
LEFT
JOIN SOROWN.DOPCO_SORVL_L B
ON B.BASE_DT \u003d DT.JOB_DT
AND B.MIS_VALDTN_ITEM_VAL \u003d \u0027UD\u0027
AND B.TBL_ENNM \u003d A.TBL_ENNM
LEFT
JOIN SOROWN.DOPCO_SORVL_L C
ON C.BASE_DT \u003d DT.JOB_DT
AND C.MISVALDTN_ITEM_VAL \u003d \u0027LD\u0027
AND C.TBL_ENNM \u003d A.TBL_ENNM
LEFT
JOIN (
SELECT
DA.JOB_BASE_DT
,DA.MIS_BTCH_PROG_ID
,SUBSTR(DA.MIS_BTCH_PROG_ID,5,13) AS TABLE_NAME
,DA.DATA_PROCS_CCNT
,DA.DW_LDNG_DTTM
,ROW_NUMBER() OVER(PARTITION BY DA.JOB_BASE_DT,SUBSTR(DA.MIS_BTCH_PROG_ID,5,13) ORDER BY DA.JOB_STRT_DTL_DTTM DESC) AS RN
FROM ADMOWN.WATCO_PULOG_L DA
WHERE DA.BTCH_JOB_PRGS_RSLT_DVCD \u003d \u002701\u0027
AND DA.MIS_BTCH_PROG_ID LIKE \u0027U%\u0027
) D
ON D.JOB_BAS_DT \u003d DT.JOB_DT
AND D.TABLE_NAME \u003d A.TBL_ENNM
AND D.RN \u003d 1
LEFT
JOIN )
SELECT EA.JOB_BASES_DT
,EA.MIS_BTCH_PROG_ID
,SUBSTR(EA.MISS_BTCH_PROG_ID,5,13) AS TABLE_NAME
,EA.DATA_PROCS_CCNT
,EA.DW_LDNG_DTTM
,ROW_NUMBER() OVER(PARTITION BY EA.JOB_BASE_DT,SUBSTR(EA.MIS_BTCH_PROG_ID,5,13) ORDER BY EA.JOB_STRT_DTL_DTTM DESC) AS RN
FROM ADMOWN.WATCO_PULOG_L EA
WHERE EA.BTCH_JOB_PRGS_PSLT_DVCD \u003d \u002701\u0027
AND EA.MIS_BTCH_PROG_ID LIKE \u0027L%\u0027
) E
ON E.JOB_BASE_DT \u003d DT.JOB_DT
AND E.TABLE_NAME \u003d A.TBL_ENNM
AND E.RN \u003d 1
LEFT
JOIN (
SELECT
TABLE_NAME AS TBL_ENNM
MCOMMENTS AS TBL_KNM
,REPLACE(COMMENTS,\u0027스냅샷\u0027,\u0027\u0027) AS TBL_KNM_SRC
FROM ALL_TAB_COMMENTS
WHERE OWNER \u003d \u0027SOROWN\u0027
AND LENGTH(TABLE_NAME) \u003d 13
AND TABLE_NAME LIKE \u0027%P\u0027
) P
ON P.TBL_KNM_SRC \u003d A.TBL_KNM
LEFT
JOIN STGOWN.DOPCO_SORVL_D Q
ON Q.JOB_TYPE LIKE \u0027UC_\u0027
AND Q.TBL_NM \u003d A.TBL_ENNM
WHERE 1\u003d1
AND ( ( DT.JOB_DT \u003d DT.LAS_DT)
OR ( DT.JOB_DT !\u003d DT.LAST_DT
  AND A.TBL_ENNM NOT IN (SELECT TBL_NM FROM STGOWN.DOPCO_SORVL_D WHERE JOB_TYPE \u003d \u0027LCM\u0027)
    )
)
AND ( (
B.VALDTN_CCNT \u003c\u003e C.VALDTN_CCNT
OR B.VALDTN_CCNT IS NULL
OR C.VALDTN_CCNT IS NULL
OR (A.TBL_ENNM NOT LIKE \u0027%P\u0027 AND D.DATA_PROCS_CCNT IS NULL)
OR E.DATA_PROCS_CCNT IS NULL
OR B.DW_LDNG_DTTM \u003c D.DW_LDNG_DTTM
OR C.DW_LDNG_DTTM \u003c E.DW_LDNG_DTTM
)
OR 1\u003d1 /* 1\u003d0 불일치 조회, 1\u003d1 전체조회 */
)
ORDER BY A.TBL_KNM
;